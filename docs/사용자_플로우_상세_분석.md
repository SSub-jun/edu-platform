# 사용자 플로우 상세 분석

## 1. 회원가입 플로우

### 1.1 학생 회원가입 (3단계 스텝퍼)

#### Step 1: 휴대폰 본인인증
```
사용자 액션:
1. /signup 페이지 접속
2. 휴대폰 번호 입력 (예: 01012345678)
3. "인증번호 받기" 버튼 클릭

백엔드 처리:
- POST /auth/phone/send-otp
- OtpRequest 생성 (phone, code, purpose='signup', expiresAt)
- 레이트 리밋 검증 (분당 1회, 일일 10회)
- 개발환경: 콘솔에 OTP 코드 출력
- 프로덕션: SMS 전송

사용자 액션:
4. 6자리 OTP 코드 입력
5. "인증하기" 버튼 클릭

백엔드 처리:
- POST /auth/phone/verify
- OTP 검증 (유효시간, 사용여부, 시도횟수)
- 성공 시 OTP 토큰 발급 (JWT, 10분 유효)
- Step 2로 진행
```

#### Step 2: 계정 정보 입력
```
사용자 액션:
1. 비밀번호 입력 (정책: 8자+, 대문자/소문자/숫자/특수문자 각 1+)
2. 비밀번호 확인 입력
3. 이메일 입력 (선택사항)
4. 초대코드 입력 (선택사항, 6자리 영문+숫자)
5. "가입하기" 버튼 클릭

백엔드 처리:
- POST /auth/register
- OTP 토큰 검증
- 비밀번호 정책 검증 (서버/클라이언트)
- 휴대폰 번호 중복 검증
- 초대코드 검증 (존재하는 경우, 6자리 형식 검증)
- User 생성 (phone, phoneVerifiedAt, passwordHash)
- 회사 배정 (초대코드 기반)
- 로그인 토큰 발급
- Step 3로 진행
```

#### Step 3: 가입 완료
```
사용자 액션:
1. 가입 완료 메시지 확인
2. "커리큘럼으로 이동" 버튼 클릭

백엔드 처리:
- 자동 로그인 상태 유지
- 회사 미배정 시 /company-assign으로 리다이렉트
- 회사 배정 완료 시 /curriculum으로 리다이렉트
```

### 1.2 관리자/강사 계정 생성

```
관리자 액션:
1. /admin 페이지 접속
2. "사용자 생성" 메뉴 선택
3. 사용자 정보 입력 (username, password, role, email)
4. "생성" 버튼 클릭

백엔드 처리:
- POST /admin/users
- JwtAuthGuard + RolesGuard 검증
- User 생성 (role: admin/instructor)
- 휴대폰 인증 없이 계정 생성
```

## 2. 로그인 플로우

### 2.1 학생 로그인
```
사용자 액션:
1. /login 페이지 접속
2. 휴대폰 번호 입력 (ID로 사용)
3. 비밀번호 입력
4. "로그인" 버튼 클릭

백엔드 처리:
- POST /auth/login
- 휴대폰 번호로 User 조회
- BCrypt 비밀번호 검증
- 단일세션 정책 적용 (기존 세션 폐기)
- Session 생성 (deviceInfo, IP, refreshTokenHash)
- Access/Refresh 토큰 발급

프론트엔드 처리:
- 토큰 저장 (쿠키 + localStorage)
- 회사 배정 상태 확인
- 미배정 시 /company-assign으로 리다이렉트
- 배정 완료 시 /curriculum으로 리다이렉트
```

### 2.2 관리자/강사 로그인
```
사용자 액션:
1. /login 페이지 접속
2. 관리자 ID 입력 (휴대폰 번호 아님)
3. 비밀번호 입력
4. "로그인" 버튼 클릭

백엔드 처리:
- POST /auth/login
- username으로 User 조회
- BCrypt 비밀번호 검증
- 단일세션 정책 적용
- Session 생성
- Access/Refresh 토큰 발급

프론트엔드 처리:
- 토큰 저장
- 역할에 따른 대시보드로 리다이렉트
```

## 3. 회사 배정 플로우

### 3.1 초대코드로 회사 배정
```
사용자 액션:
1. 회원가입 시 초대코드 입력
2. 또는 로그인 후 /company-assign 페이지 접속
3. 초대코드 입력
4. "회사 배정" 버튼 클릭

백엔드 처리:
- POST /auth/assign-company
- 초대코드로 Company 조회
- User.companyId 업데이트
- 성공 시 /curriculum으로 리다이렉트
```

### 3.2 관리자가 회사 생성 및 초대코드 관리
```
관리자 액션:
1. /admin 페이지 접속
2. "회사 관리" 메뉴 선택
3. 회사 정보 입력 (이름, 기간, 활성 레슨)
4. "회사 생성" 버튼 클릭

백엔드 처리:
- POST /admin/companies
- Company 생성
- 초대코드 필수 입력 (6자리 영문+숫자)
- 초대코드 유니크 검증

관리자 액션:
5. "초대코드 관리" 메뉴 선택
6. 초대코드 수정 (6자리 영문+숫자)

백엔드 처리:
- PATCH /admin/companies/:id/invite-code
- 초대코드 업데이트 (필수 입력)
- 유니크 검증
```

## 4. 학습 플로우

### 4.1 커리큘럼 접근
```
사용자 액션:
1. /curriculum 페이지 접속

백엔드 처리:
- GET /me/curriculum
- JwtAuthGuard 검증
- 회사 배정 상태 확인
- 과목/레슨 목록 조회
- 진행률, 잠금 상태 계산

프론트엔드 처리:
- 과목별 레슨 카드 렌더링
- 상태별 배지 표시 (잠금/학습중/시험가능/완료)
- 진행률 바 표시
```

### 4.2 레슨 학습
```
사용자 액션:
1. 레슨 카드 클릭 (잠금 해제된 레슨)
2. /lesson/[lessonId] 페이지 접속

백엔드 처리:
- GET /me/curriculum
- 레슨 접근 권한 검증 (회사 기간, 활성 레슨)
- 순차학습 검증 (이전 레슨 완료 + 시험 합격)

사용자 액션:
3. 비디오 재생 시작

백엔드 처리:
- POST /progress/ping (5초마다)
- playedMs 누적
- 진도율 계산 (≥90% 시 완료 처리)
- 디바운싱 적용 (3초)
```

## 5. 시험 플로우

### 5.1 시험 시작
```
사용자 액션:
1. 레슨 완료 후 "시험 응시" 버튼 클릭
2. /exam/lesson/[lessonId] 페이지 접속

백엔드 처리:
- POST /exam/lessons/:id/start
- 3단계 가드 검증:
  1. EnrollmentGuard (회사 소속 + 수강기간)
  2. ActiveLessonGuard (활성 레슨)
  3. LessonProgressGuard (진도율 ≥90%)
- 문항수 검증 (≥30문항)
- 랜덤 10문항 출제
- ExamAttempt 생성 (questionIds 저장)

프론트엔드 처리:
- 10문항 렌더링
- 문항 네비게이션 제공
- 이탈 방지 (beforeunload)
```

### 5.2 시험 제출
```
사용자 액션:
1. 답안 선택 (4지선다)
2. "시험 제출" 버튼 클릭

백엔드 처리:
- POST /exam/attempts/:attemptId/submit
- questionIds 매칭 검증
- 자동 채점 (Choice.isAnswer 기준)
- 점수 계산 (정답수/문항수 × 100)
- 합격 여부 판정 (≥70점)
- ExamAttempt 업데이트

프론트엔드 처리:
- /exam/result 페이지로 리다이렉트
- 점수, 합격여부, 피드백 표시
```

### 5.3 시험 재응시
```
사용자 액션:
1. 불합격 시 "재응시" 버튼 클릭

백엔드 처리:
- POST /exam/lessons/:id/retake
- 재응시 규칙 검증:
  - cycle 1: tryIndex 1→3
  - cycle 2: tryIndex 1→3
  - 이후 기회 없음
- 새로운 ExamAttempt 생성
- 랜덤 10문항 재출제
```

## 6. 네비게이션 및 리다이렉트

### 6.1 루트 경로 처리
```
사용자 액션:
1. localhost:3000 접속

미들웨어 처리:
- 토큰 유무 확인
- 토큰 있음: /curriculum으로 리다이렉트
- 토큰 없음: /login으로 리다이렉트
```

### 6.2 로그인 페이지 접근
```
사용자 액션:
1. /login 페이지 접속

미들웨어 처리:
- 토큰 유무 확인
- 토큰 있음: /curriculum으로 리다이렉트
- 토큰 없음: 로그인 페이지 표시
```

### 6.3 보호된 라우트 접근
```
사용자 액션:
1. 보호된 라우트 접근 (예: /curriculum, /lesson)

미들웨어 처리:
- 토큰 유무 확인
- 토큰 없음: /login?redirect=원래경로로 리다이렉트
- 토큰 있음: 페이지 표시
```

## 7. 에러 처리

### 7.1 OTP 관련 에러
```
- RATE_LIMITED: 레이트 리밋 초과
- INVALID_OTP: 잘못된 OTP 코드
- EXPIRED_OTP: 만료된 OTP 코드
- WEAK_PASSWORD: 비밀번호 정책 불일치
- PHONE_ALREADY_REGISTERED: 이미 가입된 휴대폰
```

### 7.2 회사 배정 관련 에러
```
- INVALID_INVITE_CODE: 잘못된 초대코드 (6자리 형식 불일치)
- ALREADY_ASSIGNED: 이미 배정된 사용자
- COMPANY_INACTIVE: 비활성 회사
- INVITE_CODE_CONFLICT: 중복된 초대코드
```

### 7.3 시험 관련 에러
```
- 403 Forbidden: 회사 기간/활성 레슨/진도율 미충족
- 422 Unprocessable Entity: questionIds 불일치
- 409 Conflict: 재응시 기회 소진
```

## 8. 개발 환경 특별 기능

### 8.1 OTP 테스트
```
개발자 액션:
1. 터미널에서 OTP 조회
   curl "http://localhost:4000/dev/otp/recent?phone=01012345678"

백엔드 처리:
- GET /dev/otp/recent
- 개발환경 전용
- 최근 유효한 OTP 코드 반환
- 프로덕션에서는 비활성화
```

### 8.2 환경변수 설정
```
필수 환경변수:
- OTP_CODE_TTL_SECONDS=300 (5분)
- OTP_RESEND_INTERVAL_SECONDS=30
- OTP_DAILY_LIMIT=10
- AUTH_OTP_JWT_SECRET (32바이트 랜덤)
- SMS_PROVIDER=mock
- SMS_SENDER_ID=EDU-PLATFORM
```

## 9. 보안 고려사항

### 9.1 OTP 보안
```
- 6자리 숫자 코드
- 5분 유효시간
- 레이트 리밋 (분당 1회, 일일 10회)
- 시도 횟수 제한
- 사용 후 즉시 무효화
```

### 9.2 비밀번호 보안
```
- BCrypt 해시
- 강력한 비밀번호 정책
- 서버/클라이언트 이중 검증
```

### 9.3 토큰 보안
```
- JWT Access/Refresh 토큰
- 단일세션 정책
- 세션 추적 및 폐기
- 자동 토큰 갱신
```

이 문서는 edu-platform의 전체 사용자 플로우를 상세히 분석한 것입니다. 각 단계별로 사용자 액션, 백엔드 처리, 프론트엔드 처리를 명확히 구분하여 기술했습니다.
